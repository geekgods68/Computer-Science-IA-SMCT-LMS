<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance - Teacher Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .content-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .page-title {
            color: #28a745;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 12px 20px;
            margin-right: 5px;
            border-radius: 8px;
        }
        
        .nav-tabs .nav-link.active {
            background-color: #28a745;
            color: white;
        }
        
        .class-selector {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px dashed #dee2e6;
        }
        
        .attendance-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .attendance-table th {
            background-color: #28a745;
            color: white;
            font-weight: 500;
            padding: 15px;
            border: none;
        }
        
        .attendance-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }
        
        .status-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .status-btn {
            min-width: 70px;
            padding: 6px 12px;
            border-radius: 20px;
            border: 2px solid;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .status-btn.present {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .status-btn.present.active {
            background: #28a745;
            color: white;
        }
        
        .status-btn.absent {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        
        .status-btn.absent.active {
            background: #dc3545;
            color: white;
        }
        
        .status-btn.late {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        
        .status-btn.late.active {
            background: #ffc107;
            color: #000;
        }
        
        .status-btn.excused {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        
        .status-btn.excused.active {
            background: #17a2b8;
            color: white;
        }
        
        .student-name {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .student-email {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .notes-input {
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 0.9rem;
            width: 100%;
            min-width: 120px;
        }
        
        .report-card {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .report-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .report-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .save-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('teacher.dashboard') }}">
                <i class="bi bi-mortarboard me-2"></i>Teacher Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('teacher.dashboard') }}">
                    <i class="bi bi-house me-1"></i>Dashboard
                </a>
                <a class="nav-link" href="{{ url_for('auth.logout') }}">
                    <i class="bi bi-box-arrow-right me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <div class="content-card">
            <h2 class="page-title">
                <i class="bi bi-check-circle"></i>Attendance Management
            </h2>
            
            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs mb-4">
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if view == 'mark' else '' }}" 
                       href="{{ url_for('teacher.my_attendance', view='mark') }}">
                        <i class="bi bi-calendar-check me-1"></i>Mark Attendance
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if view == 'reports' else '' }}" 
                       href="{{ url_for('teacher.my_attendance', view='reports') }}">
                        <i class="bi bi-graph-up me-1"></i>View Reports
                    </a>
                </li>
            </ul>
            
            <!-- Mark Attendance View -->
            {% if view == 'mark' %}
            <div class="class-selector">
                <h5 class="mb-3">
                    <i class="bi bi-calendar-date me-2"></i>Select Class and Date
                </h5>
                
                <form method="GET" action="{{ url_for('teacher.my_attendance') }}">
                    <input type="hidden" name="view" value="mark">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="class_id" class="form-label">Class</label>
                            <select class="form-select" id="class_id" name="class_id" required onchange="this.form.submit()">
                                <option value="">Choose a class...</option>
                                {% for class in teacher_classes %}
                                <option value="{{ class[0] }}" {{ 'selected' if selected_class == class[0] else '' }}>
                                    {{ class[1] }}
                                    {% if class[2] %} - Grade {{ class[2] }}{% endif %}
                                    ({{ class[3] }} students)
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="date" name="date" 
                                   value="{{ selected_date }}" onchange="this.form.submit()">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary d-block w-100">
                                <i class="bi bi-search"></i>Load
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Attendance Form -->
            {% if attendance_data %}
            <form method="POST" action="{{ url_for('teacher.save_attendance') }}">
                <input type="hidden" name="class_id" value="{{ selected_class }}">
                <input type="hidden" name="attendance_date" value="{{ selected_date }}">
                
                <div class="attendance-table">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 25%;">Student</th>
                                <th style="width: 40%;">Status</th>
                                <th style="width: 35%;">Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in attendance_data %}
                            <tr>
                                <td>
                                    <div class="student-name">{{ student.student_name }}</div>
                                    <div class="student-email">{{ student.student_email }}</div>
                                </td>
                                <td>
                                    <div class="status-buttons">
                                        <input type="radio" class="btn-check" name="status_{{ student.student_id }}" 
                                               id="present_{{ student.student_id }}" value="present"
                                               {{ 'checked' if student.status == 'present' else '' }}>
                                        <label class="status-btn present" for="present_{{ student.student_id }}">
                                            <i class="bi bi-check-circle"></i> Present
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="status_{{ student.student_id }}" 
                                               id="absent_{{ student.student_id }}" value="absent"
                                               {{ 'checked' if student.status == 'absent' else '' }}>
                                        <label class="status-btn absent" for="absent_{{ student.student_id }}">
                                            <i class="bi bi-x-circle"></i> Absent
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="status_{{ student.student_id }}" 
                                               id="late_{{ student.student_id }}" value="late"
                                               {{ 'checked' if student.status == 'late' else '' }}>
                                        <label class="status-btn late" for="late_{{ student.student_id }}">
                                            <i class="bi bi-clock"></i> Late
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="status_{{ student.student_id }}" 
                                               id="excused_{{ student.student_id }}" value="excused"
                                               {{ 'checked' if student.status == 'excused' else '' }}>
                                        <label class="status-btn excused" for="excused_{{ student.student_id }}">
                                            <i class="bi bi-shield-check"></i> Excused
                                        </label>
                                    </div>
                                </td>
                                <td>
                                    <input type="text" name="notes_{{ student.student_id }}" 
                                           class="notes-input" placeholder="Optional notes..."
                                           value="{{ student.notes or '' }}">
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="save-section">
                    <h6><i class="bi bi-save me-2"></i>Save Attendance</h6>
                    <p class="text-muted small mb-3">Make sure to save your attendance entries before leaving this page.</p>
                    <div class="d-flex justify-content-center gap-3">
                        <button type="button" class="btn btn-outline-success" onclick="markAllPresent()">
                            <i class="bi bi-check-all me-1"></i>Mark All Present
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-save me-1"></i>Save Attendance
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearAll()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Reset
                        </button>
                    </div>
                </div>
            </form>
            {% elif selected_class %}
                <div class="text-center text-muted py-5">
                    <i class="bi bi-people" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">No Students Found</h5>
                    <p>No active students found in the selected class.</p>
                </div>
            {% endif %}
            {% endif %}
            
            <!-- Reports View -->
            {% if view == 'reports' %}
            <div>
                <h5 class="mb-4">
                    <i class="bi bi-graph-up me-2"></i>Attendance Reports
                </h5>
                
                {% if attendance_reports %}
                    <div class="row">
                        {% for report in attendance_reports %}
                        <div class="col-lg-6 col-xl-4 mb-4">
                            <div class="report-card">
                                <h6 class="mb-2">{{ report[0] }}</h6>
                                {% if report[1] %}
                                    <small>Grade {{ report[1] }}</small>
                                {% endif %}
                                
                                <div class="row mt-3">
                                    <div class="col-6">
                                        <div class="report-number">{{ report[3] or 0 }}</div>
                                        <div class="report-label">Present</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="report-number">{{ report[4] or 0 }}</div>
                                        <div class="report-label">Absent</div>
                                    </div>
                                </div>
                                
                                <div class="row mt-2">
                                    <div class="col-6">
                                        <div class="small">Late: {{ report[5] or 0 }}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="small">Days: {{ report[6] or 0 }}</div>
                                    </div>
                                </div>
                                
                                {% if report[2] > 0 %}
                                    {% set attendance_rate = ((report[3] or 0) * 100 / ((report[3] or 0) + (report[4] or 0))) if (report[3] or 0) + (report[4] or 0) > 0 else 0 %}
                                    <div class="mt-3">
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar bg-white" 
                                                 style="width: {{ attendance_rate }}%"></div>
                                        </div>
                                        <small class="mt-1 d-block">{{ attendance_rate|round }}% attendance rate</small>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-graph-up" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">No Attendance Data</h5>
                        <p>No attendance records found to generate reports.</p>
                        <a href="{{ url_for('teacher.my_attendance', view='mark') }}" class="btn btn-success">
                            <i class="bi bi-calendar-check me-2"></i>Start Taking Attendance
                        </a>
                    </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function markAllPresent() {
            document.querySelectorAll('input[type="radio"][value="present"]').forEach(radio => {
                radio.checked = true;
            });
        }
        
        function clearAll() {
            if (confirm('This will reset all attendance entries. Continue?')) {
                document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                    radio.checked = false;
                });
                document.querySelectorAll('.notes-input').forEach(input => {
                    input.value = '';
                });
            }
        }
        
        // Auto-save functionality
        let autoSaveTimeout;
        document.addEventListener('change', function(e) {
            if (e.target.type === 'radio' || e.target.classList.contains('notes-input')) {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(function() {
                    // Could implement auto-save here
                    console.log('Changes detected - consider saving');
                }, 30000); // 30 seconds delay
            }
        });
    </script>
</body>
</html>
